rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function isValidString(field, minLen) {
      return field is string && field.size() >= minLen;
    }

    function isValidDateString(field) {
      // Basic YYYY-MM-DD length check
      return field is string && field.size() == 10;
    }

    function isNonNegativeNumber(n) {
      return n is number && n >= 0;
    }

    function isValidStatus(s) {
      return s in ['pending','completed','cancelled','confirmed','paid'];
    }

    function isSignedIn() {
      return request.auth != null;
    }

    function isSuperAdmin() {
      // Check the caller's role from users collection
      return isSignedIn() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superadmin';
    }
    
    // Products collection - Read only for everyone
    match /products/{productId} {
      // Allow anyone to read products
      allow read: if true;
      
      // Only allow authenticated users or admins to write
      // Modify this based on your authentication requirements
      allow write: if false; // Set to true or add auth conditions as needed
    }
    
    // Orders collection - Create allowed, read optional, limited updates
    match /orders/{orderId} {
      // Allow anyone to create new orders with schema validation
      allow create: if
        isValidString(request.resource.data.customerName, 2) &&
        // Accept phone as string or number
        (
          (request.resource.data.phoneNumber is string && request.resource.data.phoneNumber.size() >= 0) ||
          (request.resource.data.phoneNumber is number)
        ) &&
        isValidString(request.resource.data.location, 5) &&
        isValidDateString(request.resource.data.startDate) &&
        isValidDateString(request.resource.data.endDate) ;
        
      
      // Allow read for everyone (adjust as needed)
      allow read: if true;
      
      // Allow status-only updates (pending -> completed or cancelled), and update timestamp
      allow update: if
        // only status and updatedAt can change
        request.resource.data.diff(resource.data).changedKeys().hasOnly(['status','updatedAt']) &&
        isValidStatus(request.resource.data.status) &&
        request.resource.data.updatedAt is timestamp &&
        // restrict transitions: only from pending to completed/cancelled or no-op
        (
          resource.data.status == request.resource.data.status ||
          (resource.data.status == 'pending' && (request.resource.data.status == 'completed' || request.resource.data.status == 'cancelled'))
        );

      // Prevent deletes from clients
      allow delete: if false;
    }

    // Users collection - store user profiles and roles
    match /users/{uid} {
      // Read own profile; superadmin can read all
      allow read: if isSignedIn() && (request.auth.uid == uid || isSuperAdmin());

      // Create/update by superadmin only
      allow create, update: if isSuperAdmin() &&
        request.resource.data.keys().hasAll(['email','role','createdAt']) &&
        isValidString(request.resource.data.email, 3) &&
        request.resource.data.role in ['superadmin','admin','user','anonymous'] &&
        request.resource.data.createdAt is timestamp;

      // Prevent deletes from clients
      allow delete: if false;
    }
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
